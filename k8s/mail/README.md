# Mail Architecture (Multi-Tenant)

## Design

- **Single cluster**: Postfix, Dovecot, Rspamd run in `mail-system` namespace. No per-tenant mail containers.
- **Database-driven**: MySQL holds virtual domains, users, aliases. Panel API inserts rows when a domain is provisioned.
- **DKIM**: One key per domain; generated by Panel (e.g. OpenSSL), stored as Kubernetes Secret in `mail-system` (e.g. `dkim-<domain-sanitized>`). Postfix/Rspamd use the key via shared volume or config.
- **SPF/DMARC**: Records are created in PowerDNS by Panel (TXT records). No mail containers in tenant namespaces.

## Mail ↔ DNS

- Panel adds domain to `mail-system` MySQL (virtual_domains, etc.).
- Panel creates DNS zone/records via PowerDNS API: A, MX, TXT (SPF, DKIM selector, DMARC).
- MX for domain points to a single hostname (e.g. `mail.platform.example.com`) that resolves to Traefik → mail-system Service.

## Mail storage

- **Maildir** per domain or per user under a single volume (e.g. `/var/mail/vhosts/<domain>/user`). Dovecot uses `mail_location` and MySQL userdb to resolve paths.
- Structure: `PVC mail-data` → `/var/mail/vhosts/<domain>/<user>/` (Maildir).

## MySQL schema

Create ConfigMap and run init job once:

```bash
kubectl create configmap mail-schema -n mail-system --from-file=mysql-schema.sql="$(pwd)/k8s/mail/mysql-schema.sql"
kubectl apply -f k8s/system/mail-system/mysql-schema-job.yaml
```

## Domain insertion (Panel)

1. Insert into `virtual_domains` (domain, customer_id).
2. Insert into `virtual_users` (email, domain_id, password hash).
3. Insert aliases in `virtual_aliases` if needed.
4. Generate DKIM key, create Secret `dkim-<domain>`, mount or copy into Rspamd/Postfix config.
5. Create DNS records (MX, SPF, DKIM TXT, DMARC TXT) via PowerDNS API.

{{/*
  ZON — İzleme (vhp-observability)
  Prometheus, Loki, Grafana config/servisleri. values: observability.enabled
*/}}
{{- if .Values.observability.enabled }}
apiVersion: v1
kind: Namespace
metadata:
  name: vhp-observability
  labels:
    vhp-layer: infrastructure
    vhp-type: observability
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: observability-quota
  namespace: vhp-observability
spec:
  hard:
    requests.cpu: "4"
    requests.memory: "8Gi"
    limits.cpu: "8"
    limits.memory: "16Gi"
    pods: "30"
---
apiVersion: v1
kind: LimitRange
metadata:
  name: observability-limits
  namespace: vhp-observability
spec:
  limits:
  - default:
      cpu: "1"
      memory: 2Gi
    defaultRequest:
      cpu: 100m
      memory: 256Mi
    type: Container
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: observability-allow-scraping
  namespace: vhp-observability
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 9090
    - protocol: TCP
      port: 3100
    - protocol: TCP
      port: 3000
  egress:
  - {}
---
{{- if .Values.observability.prometheus }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: vhp-observability
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
    scrape_configs:
    - job_name: 'kubernetes-apiservers'
      kubernetes_sd_configs:
      - role: endpoints
      scheme: https
      tls_config:
        insecure_skip_verify: true
---
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  namespace: vhp-observability
  labels:
    app: prometheus
spec:
  type: ClusterIP
  ports:
  - port: 9090
    targetPort: 9090
    name: http
  selector:
    app: prometheus
{{- end }}
---
{{- if .Values.observability.loki }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-config
  namespace: vhp-observability
data:
  loki.yaml: |
    auth_enabled: false
    server:
      http_listen_port: 3100
---
apiVersion: v1
kind: Service
metadata:
  name: loki
  namespace: vhp-observability
  labels:
    app: loki
spec:
  type: ClusterIP
  ports:
  - port: 3100
    targetPort: 3100
    name: http
  selector:
    app: loki
{{- end }}
---
{{- if .Values.observability.grafana }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: vhp-observability
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      url: http://prometheus.vhp-observability.svc.cluster.local:9090
      access: proxy
    - name: Loki
      type: loki
      url: http://loki.vhp-observability.svc.cluster.local:3100
      access: proxy
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: vhp-observability
  labels:
    app: grafana
spec:
  type: ClusterIP
  ports:
  - port: 3000
    targetPort: 3000
    name: http
  selector:
    app: grafana
{{- end }}
{{- end }}

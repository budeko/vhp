{{/*
  SİSTEM — Sertifika (vhp-cert)
  Let's Encrypt ClusterIssuer (staging + prod). values: cert.enabled
*/}}
{{- if .Values.cert.enabled }}
apiVersion: v1
kind: Namespace
metadata:
  name: vhp-cert
  labels:
    vhp-layer: infrastructure
    vhp-type: security
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: vhp-letsencrypt-staging
spec:
  acme:
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: {{ .Values.global.letsEncryptEmail | quote }}
    privateKeySecretRef:
      name: vhp-letsencrypt-staging-key
    solvers:
    - http01:
        ingress:
          class: vhp-traefik
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: vhp-letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: {{ .Values.global.letsEncryptEmail | quote }}
    privateKeySecretRef:
      name: vhp-letsencrypt-prod-key
    solvers:
    - http01:
        ingress:
          class: vhp-traefik
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: cert-quota
  namespace: vhp-cert
spec:
  hard:
    requests.cpu: "500m"
    requests.memory: "512Mi"
    limits.cpu: "1"
    limits.memory: "1Gi"
    pods: "10"
---
apiVersion: v1
kind: LimitRange
metadata:
  name: cert-limits
  namespace: vhp-cert
spec:
  limits:
  - default:
      cpu: 100m
      memory: 128Mi
    defaultRequest:
      cpu: 50m
      memory: 64Mi
    type: Container
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cert-allow-ingress
  namespace: vhp-cert
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          vhp-layer: infrastructure
    - namespaceSelector:
        matchLabels:
          vhp-layer: management
{{- end }}

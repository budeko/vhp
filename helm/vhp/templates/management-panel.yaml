{{/*
  YÖNETİM — Panel arayüzü (vhp-panel)
  Web UI, TLS Certificate, Ingress. values: panel.enabled
*/}}
{{- if .Values.panel.enabled }}
apiVersion: v1
kind: Namespace
metadata:
  name: vhp-panel
  labels:
    vhp-layer: management
    vhp-type: panel
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: vhp-panel-cert
  namespace: vhp-panel
spec:
  secretName: vhp-panel-tls
  issuerRef:
    name: vhp-letsencrypt-prod
    kind: ClusterIssuer
  commonName: {{ .Values.global.panelHost }}
  dnsNames:
  - {{ .Values.global.panelHost }}
---
# Panel ilk açılışta bu hesapla admin oluşturur; sonra panel üzerinden kullanıcı eklenir
apiVersion: v1
kind: Secret
metadata:
  name: vhp-admin-credentials
  namespace: vhp-panel
  labels:
    app: vhp-panel
type: Opaque
stringData:
  admin-username: {{ .Values.global.adminUsername | default "admin" | quote }}
  admin-password: {{ .Values.global.adminPassword | default "" | quote }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vhp-panel
  namespace: vhp-panel
  labels:
    app: vhp-panel
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vhp-panel
  template:
    metadata:
      labels:
        app: vhp-panel
    spec:
      containers:
      - name: panel
        image: {{ .Values.global.imageRegistry }}/{{ .Values.global.panelImage }}
        ports:
        - containerPort: 3000
          name: http
        env:
        - name: VHP_CONTROLLER_URL
          value: "http://vhp-controller.vhp-control.svc.cluster.local:8080"
        - name: VHP_PANEL_HOST
          value: {{ .Values.global.panelHost | quote }}
        - name: VHP_ADMIN_USERNAME
          valueFrom:
            secretKeyRef:
              name: vhp-admin-credentials
              key: admin-username
        - name: VHP_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: vhp-admin-credentials
              key: admin-password
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 10
          periodSeconds: 15
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: vhp-panel
  namespace: vhp-panel
  labels:
    app: vhp-panel
spec:
  type: ClusterIP
  ports:
  - port: 3000
    targetPort: 3000
    name: http
    protocol: TCP
  selector:
    app: vhp-panel
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: vhp-panel
  namespace: vhp-panel
  annotations:
    cert-manager.io/cluster-issuer: vhp-letsencrypt-prod
spec:
  ingressClassName: vhp-traefik
  tls:
  - hosts:
    - {{ .Values.global.panelHost }}
    secretName: vhp-panel-tls
  rules:
  - host: {{ .Values.global.panelHost }}
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: vhp-panel
            port:
              number: 3000
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: panel-quota
  namespace: vhp-panel
spec:
  hard:
    requests.cpu: "500m"
    requests.memory: "512Mi"
    limits.cpu: "1"
    limits.memory: "1Gi"
    pods: "5"
---
apiVersion: v1
kind: LimitRange
metadata:
  name: panel-limits
  namespace: vhp-panel
spec:
  limits:
  - default:
      cpu: 500m
      memory: 512Mi
    defaultRequest:
      cpu: 100m
      memory: 128Mi
    type: Container
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: panel-allow-ingress-from-core
  namespace: vhp-panel
spec:
  podSelector:
    matchLabels:
      app: vhp-panel
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          vhp-layer: infrastructure
    - namespaceSelector:
        matchLabels:
          vhp-layer: management
    ports:
    - protocol: TCP
      port: 3000
{{- end }}

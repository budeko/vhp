{{/*
  ZON — Image build (Kaniko) (vhp-build)
  Cluster içinde Dockerfile'dan image build. Flux ile tetiklenebilir. values: build.enabled
*/}}
{{- if .Values.build.enabled }}
apiVersion: v1
kind: Namespace
metadata:
  name: vhp-build
  labels:
    vhp-layer: infrastructure
    vhp-type: build
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kaniko
  namespace: vhp-build
---
# Registry push için: kurulumda kubectl create secret docker-registry kaniko-registry -n vhp-build ... ile gerçek değer verin
apiVersion: v1
kind: Secret
metadata:
  name: kaniko-registry
  namespace: vhp-build
type: kubernetes.io/dockerconfigjson
stringData:
  .dockerconfigjson: '{"auths":{}}'
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: kaniko-build
  namespace: vhp-build
spec:
  schedule: {{ .Values.build.kaniko.schedule | default "0 2 * * *" | quote }}
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: kaniko
          restartPolicy: Never
          containers:
          - name: kaniko
            image: gcr.io/kaniko-project/executor:v1.22.0
            args:
            - --dockerfile={{ .Values.build.kaniko.dockerfilePath | default "Dockerfile" }}
            - --context={{ .Values.build.kaniko.context | default "git://github.com/your-org/repo#refs/heads/main" }}
            - --destination={{ .Values.build.kaniko.imageDestination | quote }}
            - --cache=true
            - --cache-ttl=168h
            volumeMounts:
            - name: registry-secret
              mountPath: /kaniko/.docker
              readOnly: true
          volumes:
          - name: registry-secret
            secret:
              secretName: kaniko-registry
              items:
              - key: .dockerconfigjson
                path: config.json
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: build-quota
  namespace: vhp-build
spec:
  hard:
    requests.cpu: "2"
    requests.memory: "4Gi"
    limits.cpu: "4"
    limits.memory: "8Gi"
    pods: "10"
    cronjobs.batch: "5"
---
apiVersion: v1
kind: LimitRange
metadata:
  name: build-limits
  namespace: vhp-build
spec:
  limits:
  - default:
      cpu: "2"
      memory: 4Gi
    defaultRequest:
      cpu: 500m
      memory: 1Gi
    type: Container
{{- end }}
